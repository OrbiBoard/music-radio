<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>下载管理</title>
  <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
  <style>
    html, body { height: 100%; margin: 0; background: #181818; color: #e6e6e6; font-family: system-ui, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif; }
    .wrap { height: 100%; display: flex; flex-direction: column; }
    header { padding: 12px 16px; font-weight: 600; border-bottom: 1px solid #2a2a2a; display: flex; align-items: center; justify-content: space-between; }
    .content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .settings { padding: 16px; border-bottom: 1px solid #2a2a2a; }
    .settings-row { display: flex; align-items: center; margin-bottom: 12px; gap: 10px; font-size: 13px; }
    .settings-row:last-child { margin-bottom: 0; }
    input[type="text"] { flex: 1; background: #202020; border: 1px solid #333; color: #eee; padding: 6px 10px; border-radius: 4px; font-size: 12px; }
    input[type="checkbox"] { margin: 0; }
    button { padding: 6px 12px; border-radius: 4px; border: 1px solid #333; background: #2a2a2a; color: #eee; cursor: pointer; font-size: 12px; }
    button:hover { background: #333; }
    .list { flex: 1; overflow-y: auto; padding: 0; }
    .item { padding: 10px 16px; border-bottom: 1px solid #222; display: flex; align-items: center; gap: 12px; }
    .item .info { flex: 1; min-width: 0; }
    .item .title { font-size: 13px; color: #eee; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item .status { font-size: 11px; color: #888; margin-top: 2px; }
    .item .progress { width: 60px; text-align: right; font-size: 12px; color: #aaa; }
    .empty { padding: 40px; text-align: center; color: #555; font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <span>下载管理</span>
      <button onclick="refreshList()"><i class="ri-refresh-line"></i></button>
    </header>
    <div class="settings">
      <div class="settings-row">
        <span style="width:60px; color:#aaa;">保存目录</span>
        <div style="flex:1; display:flex; gap:6px;">
          <input type="text" id="dlDir" placeholder="下载路径">
          <button id="browseBtn" style="white-space:nowrap; padding: 6px 10px;"><i class="ri-folder-open-line"></i> 浏览</button>
        </div>
      </div>
      <div class="settings-row">
        <span style="width:60px; color:#aaa;">命名格式</span>
        <input type="text" id="dlFormat" placeholder="{t} - {a}" title="{t}标题 {a}歌手 {l}专辑">
      </div>
      <div class="settings-row">
        <span style="width:60px; color:#aaa;">选项</span>
        <label style="display:flex; align-items:center; gap:6px; cursor:pointer;">
          <input type="checkbox" id="dlLrc">
          <span>同时下载歌词 (.lrc)</span>
        </label>
        <div style="flex:1"></div>
        <button id="saveSettings">保存设置</button>
      </div>
    </div>
    <div class="list" id="list">
      <div class="empty">暂无下载任务</div>
    </div>
  </div>
  <script>
    const listEl = document.getElementById('list');
    const dirInput = document.getElementById('dlDir');
    const browseBtn = document.getElementById('browseBtn');
    const fmtInput = document.getElementById('dlFormat');
    const lrcInput = document.getElementById('dlLrc');
    const saveBtn = document.getElementById('saveSettings');

    async function loadSettings() {
      try {
        const r = await window.lowbarAPI.pluginCall('music-radio', 'getDownloadSettings', []);
        const s = (r && r.result ? r.result.settings : (r && r.settings ? r.settings : {}));
        if (s) {
          if (s.dir) dirInput.value = s.dir;
          if (s.format) fmtInput.value = s.format;
          lrcInput.checked = !!s.lrc;
        }
      } catch (e) {}
    }

    async function saveSettings() {
      try {
        await window.lowbarAPI.pluginCall('music-radio', 'setDownloadSettings', [{
          dir: dirInput.value,
          format: fmtInput.value,
          lrc: lrcInput.checked
        }]);
        alert('设置已保存');
      } catch (e) { alert('保存失败'); }
    }

    function renderList(items) {
      if (!items || !items.length) {
        listEl.innerHTML = '<div class="empty">暂无下载任务</div>';
        return;
      }
      listEl.innerHTML = '';
      items.forEach(it => {
        const div = document.createElement('div');
        div.className = 'item';
        let statusText = '等待中';
        let color = '#888';
        if (it.status === 'downloading') { statusText = '下载中...'; color = '#9ad'; }
        else if (it.status === 'completed') { statusText = '已完成'; color = '#5b8'; }
        else if (it.status === 'failed') { statusText = '失败: ' + (it.error || '未知错误'); color = '#f55'; }
        
        div.innerHTML = `
          <div class="info">
            <div class="title" title="${it.title}">${it.title}</div>
            <div class="status" style="color:${color}">${statusText}</div>
          </div>
          <div class="progress">${it.status === 'downloading' ? it.progress + '%' : ''}</div>
        `;
        listEl.appendChild(div);
      });
    }

    async function refreshList() {
      try {
        const r = await window.lowbarAPI.pluginCall('music-radio', 'getDownloads', []);
        const items = (r && r.result ? r.result.items : (r && r.items ? r.items : [])) || [];
        renderList(items);
      } catch (e) {}
    }

    if (saveBtn) saveBtn.onclick = saveSettings;
    if (browseBtn) {
      browseBtn.onclick = async () => {
        try {
          const r = await window.lowbarAPI.pluginCall('music-radio', 'selectDirectory', []);
          const res = r && r.result ? r.result : r;
          if (res && res.ok && res.path) {
            dirInput.value = res.path;
          }
        } catch (e) { console.error(e); }
      };
    }

    // Listen for updates
    const ch = 'music-radio';
    if (window.lowbarAPI.subscribe) {
      window.lowbarAPI.subscribe(ch);
      window.lowbarAPI.onEvent((name, payload) => {
        if (name === ch && payload && payload.type === 'update' && payload.target === 'downloadList') {
          renderList(payload.value || []);
        }
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      refreshList();
    });
  </script>
</body>
</html>