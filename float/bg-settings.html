<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>背景设置</title>
  <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
  <style>
    :root {
      --bg: #181818;
      --fg: #e6e6e6;
      --muted: #9c9c9c;
      --border: #2a2a2a;
      --accent: #6ab4ff;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font-family: system-ui, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif; transition: background 0.3s, color 0.3s; }
    .wrap { height: 100%; display: flex; flex-direction: column; }
    header { padding: 12px 16px; font-weight: 600; border-bottom: 1px solid var(--border); }
    .content { padding: 16px; display: grid; grid-template-columns: 1fr; gap: 14px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .row label { font-size: 14px; color:var(--fg); opacity: 0.8; }
    .row select, .row input[type="range"], .row input[type="checkbox"] { width: 160px; }
    .hint { font-size:12px; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>背景设置</header>
    <div class="content">
      <div class="row">
        <label for="bgMode">背景模式</label>
        <select id="bgMode">
          <option value="blur">封面模糊</option>
          <option value="shine">流动光影</option>
        </select>
      </div>
      <div id="blurGroup">
        <div class="row">
          <label for="blurPx">模糊强度</label>
          <input id="blurPx" type="range" min="10" max="120" step="1" />
        </div>
        <div class="row">
          <label for="darkRate">亮度衰减</label>
          <input id="darkRate" type="range" min="0.2" max="1.0" step="0.01" />
        </div>
      </div>
      <div id="shineGroup">
        <div class="row">
          <label for="shineReactive">根据音频律动</label>
          <input id="shineReactive" type="checkbox" />
        </div>
        <div class="hint">启用后，光影缩放与旋转速度会根据频段与音量变化。</div>
      </div>
      <div class="row">
        <label for="spectrumEnabled">可视化频谱</label>
        <input id="spectrumEnabled" type="checkbox" />
      </div>
    </div>
  </div>
  <script>
    // 注入主题逻辑
    window.applyTheme = (mode, color) => {
      const root = document.documentElement;
      const isDark = mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
      const accent = color || '#6ab4ff';
      root.style.setProperty('--accent', accent);
      if (isDark) {
        root.style.setProperty('--bg', '#181818');
        root.style.setProperty('--fg', '#e6e6e6');
        root.style.setProperty('--muted', '#9c9c9c');
        root.style.setProperty('--border', '#2a2a2a');
      } else {
        root.style.setProperty('--bg', '#ffffff');
        root.style.setProperty('--fg', '#333333');
        root.style.setProperty('--muted', '#666666');
        root.style.setProperty('--border', '#e0e0e0');
      }
    };

    (async () => {
      try {
        if (window.lowbarAPI?.configGet) {
          const mode = await window.lowbarAPI.configGet('system', 'themeMode') || 'system';
          const color = await window.lowbarAPI.configGet('system', 'themeColor') || '#6ab4ff';
          window.applyTheme(mode, color);
        }
        if (window.lowbarAPI?.onConfigChanged) {
          window.lowbarAPI.onConfigChanged(({ scope, key, value }) => {
            if (scope === 'system') {
               (async () => {
                 const m = await window.lowbarAPI.configGet('system', 'themeMode') || 'system';
                 const c = await window.lowbarAPI.configGet('system', 'themeColor') || '#6ab4ff';
                 window.applyTheme(m, c);
               })();
            }
          });
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', async () => {
           const m = await window.lowbarAPI.configGet('system', 'themeMode') || 'system';
           if (m === 'system') {
              const c = await window.lowbarAPI.configGet('system', 'themeColor') || '#6ab4ff';
              window.applyTheme('system', c);
           }
        });
      } catch (e) { console.error('Theme init failed', e); }
    })();

    (function(){
      const updateProgress = (el) => {
        const min = parseFloat(el.min || 0);
        const max = parseFloat(el.max || 100);
        const val = parseFloat(el.value || 0);
        const ratio = (val - min) / (max - min) * 100;
        el.style.setProperty('--progress', ratio + '%');
      };

      document.querySelectorAll('input[type="range"]').forEach(el => {
        updateProgress(el);
        el.addEventListener('input', () => updateProgress(el));
      });

      const bgModeEl = document.getElementById('bgMode');
      const blurEl = document.getElementById('blurPx');
      const darkEl = document.getElementById('darkRate');
      const shineReactiveEl = document.getElementById('shineReactive');
      const spectrumEnabledEl = document.getElementById('spectrumEnabled');
      const blurGroup = document.getElementById('blurGroup');
      const shineGroup = document.getElementById('shineGroup');
      function read(k, def){ try { const v = localStorage.getItem(k); return v===null||v===undefined ? def : v; } catch (e) { return def; } }
      function write(k, v){ try { localStorage.setItem(k, String(v)); } catch (e) {} }
      function emitApply(){ try { window.lowbarAPI.pluginCall('music-radio','onLowbarEvent',[{ type:'update', target:'bgModeApply', value:'apply' }]); } catch (e) {} }
      function updateGroupVis(){
        const mode = String(bgModeEl.value||'blur');
        blurGroup.style.display = (mode === 'blur') ? 'block' : 'none';
        shineGroup.style.display = (mode === 'shine') ? 'block' : 'none';
      }
      function init(){
        bgModeEl.value = String(read('radio.bgmode','blur'));
        blurEl.value = String(read('radio.bg.blur','70'));
        darkEl.value = String(read('radio.bg.dark','0.6'));
        shineReactiveEl.checked = read('radio.shine.audioReactive','1') !== '0';
        spectrumEnabledEl.checked = read('radio.spectrum.enabled','1') !== '0';
        updateGroupVis();
      }
      init();
      bgModeEl.addEventListener('change', () => { write('radio.bgmode', bgModeEl.value||'blur'); updateGroupVis(); emitApply(); });
      blurEl.addEventListener('input', () => { write('radio.bg.blur', blurEl.value||'70'); emitApply(); });
      darkEl.addEventListener('input', () => { write('radio.bg.dark', darkEl.value||'0.6'); emitApply(); });
      shineReactiveEl.addEventListener('change', () => { write('radio.shine.audioReactive', shineReactiveEl.checked ? '1':'0'); emitApply(); });
      spectrumEnabledEl.addEventListener('change', () => { write('radio.spectrum.enabled', spectrumEnabledEl.checked ? '1':'0'); emitApply(); });
    })();
  </script>
</body>
</html>
