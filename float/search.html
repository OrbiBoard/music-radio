<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="referrer" content="no-referrer" />
  <title>搜索</title>
  <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
  <style>
    :root {
      --bg: #181818;
      --fg: #e6e6e6;
      --muted: #a0a0a0;
      --border: #2a2a2a;
      --input-bg: #101010;
      --item-hover: #202020;
      --accent: #6ab4ff;
      --btn-bg: #202020;
      --scroll-thumb: #2e2e2e;
      --scroll-track: #151515;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font-family: system-ui, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif; user-select: none; -webkit-user-select: none; -ms-user-select: none; transition: background 0.3s, color 0.3s; }
    .wrap { height: 100%; display: flex; flex-direction: column; }
    header { padding: 12px 16px; font-weight: 600; border-bottom: 1px solid var(--border); }
    .content { padding: 16px; display: flex; gap: 8px; }
    input { flex: 1; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--input-bg); color: var(--fg); }
    input:focus { outline: none; box-shadow: none; border-color: var(--accent); }
    select { padding:10px 12px; border-radius:6px; border:1px solid var(--border); background:var(--input-bg); color:var(--fg); }
    button { padding: 10px 16px; border-radius: 6px; border: 1px solid var(--border); background: var(--btn-bg); color: var(--fg); cursor: pointer; transition: all 0.2s; }
    button:focus { outline: none; box-shadow: none; border-color: var(--accent); }
    button:hover { filter: brightness(1.2); }
    .scroll { flex: 1; overflow: auto; }
    .scroll::-webkit-scrollbar { width: 10px; }
    .scroll::-webkit-scrollbar-track { background: var(--scroll-track); }
    .scroll::-webkit-scrollbar-thumb { background: var(--scroll-thumb); border-radius: 6px; border: 2px solid var(--scroll-track); }
    .result { padding: 8px 16px; color: var(--muted); display:flex; flex-direction:column; gap:8px; }
    .item { display:flex; gap:12px; align-items:flex-start; padding:12px; border:1px solid var(--border); border-radius:8px; cursor:pointer; margin-bottom:10px; transition: background 0.2s; }
    .item:hover { background:var(--item-hover); border-color: var(--accent); }
    .item img { width:56px; height:56px; object-fit:cover; border-radius:6px; }
    .item .meta { display:flex; flex-direction:column; }
    .item .meta .title { color:var(--fg); }
    .item .meta .artist { color:var(--muted); font-size:12px; }
    .controls { display:flex; gap:8px; margin-left:auto; }
    .controls button { padding:6px 10px; font-size:12px; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--fg); cursor:pointer; }
    .controls i { margin-right:6px; color:var(--muted); }
    .menu { margin: -6px 16px 10px 72px; padding:8px; border:1px dashed var(--border); border-radius:8px; display:none; background:var(--bg); }
    .menu .actions { display:flex; gap:10px; }
    .menu .actions button { padding:6px 10px; font-size:12px; border-radius:6px; border:1px solid var(--border); background:var(--item-hover); color:var(--fg); cursor:pointer; }
    .menu .actions i { margin-right:6px; color:var(--muted); }
    .loadingbar { display:none; padding: 8px 16px; color:var(--accent); align-items:center; gap:8px; }
    .loadingbar i { font-size:16px; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spin { animation: spin 1s linear infinite; }
    .tip { padding: 0 16px 4px 16px; color:var(--muted); font-size:12px; }
  </style>
  <script>
    // 注入主题逻辑
    window.applyTheme = (mode, color) => {
      const root = document.documentElement;
      const isDark = mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
      
      const accent = color || '#6ab4ff';
      root.style.setProperty('--accent', accent);
      
      if (isDark) {
        root.style.setProperty('--bg', '#181818');
        root.style.setProperty('--fg', '#e6e6e6');
        root.style.setProperty('--muted', '#a0a0a0');
        root.style.setProperty('--border', '#2a2a2a');
        root.style.setProperty('--input-bg', '#101010');
        root.style.setProperty('--item-hover', '#202020');
        root.style.setProperty('--btn-bg', '#202020');
        root.style.setProperty('--scroll-thumb', '#2e2e2e');
        root.style.setProperty('--scroll-track', '#151515');
      } else {
        root.style.setProperty('--bg', '#ffffff');
        root.style.setProperty('--fg', '#333333');
        root.style.setProperty('--muted', '#666666');
        root.style.setProperty('--border', '#e0e0e0');
        root.style.setProperty('--input-bg', '#f5f5f5');
        root.style.setProperty('--item-hover', '#f0f0f0');
        root.style.setProperty('--btn-bg', '#f5f5f5');
        root.style.setProperty('--scroll-thumb', '#cccccc');
        root.style.setProperty('--scroll-track', '#f0f0f0');
      }
    };

    (async () => {
      try {
        if (window.lowbarAPI?.configGet) {
          const mode = await window.lowbarAPI.configGet('system', 'themeMode') || 'system';
          const color = await window.lowbarAPI.configGet('system', 'themeColor') || '#6ab4ff';
          window.applyTheme(mode, color);
        }
        
        if (window.lowbarAPI?.onConfigChanged) {
          window.lowbarAPI.onConfigChanged(({ scope, key, value }) => {
            if (scope === 'system') {
               (async () => {
                 const m = await window.lowbarAPI.configGet('system', 'themeMode') || 'system';
                 const c = await window.lowbarAPI.configGet('system', 'themeColor') || '#6ab4ff';
                 window.applyTheme(m, c);
               })();
            }
          });
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', async () => {
           const m = await window.lowbarAPI.configGet('system', 'themeMode') || 'system';
           if (m === 'system') {
              const c = await window.lowbarAPI.configGet('system', 'themeColor') || '#6ab4ff';
              window.applyTheme('system', c);
           }
        });
      } catch (e) { console.error('Theme init failed', e); }
    })();

    let currentPage = 0;
    let currentQuery = '';
    let currentSource = 'kuwo';
    let hasMore = false;
    let loading = false;
    let searchSeq = 0;
    let openMenu = null;
    let cachedSettings = {};
    let cachedPlaylist = { totalSecs: 0, items: [] };

    // Update caches
    async function updateCaches() {
      try {
        const r1 = await window.lowbarAPI.pluginCall('music-radio', 'getSettings', []);
        cachedSettings = (r1 && r1.result ? r1.result.settings : (r1 && r1.settings ? r1.settings : {})) || {};
        const r2 = await window.lowbarAPI.pluginCall('music-radio', 'getPlaylist', []);
        cachedPlaylist = (r2 && r2.result ? r2.result : r2) || { totalSecs: 0, items: [] };
      } catch (e) {}
    }

    function renderItems(items){
      const r = document.getElementById('result');
      const now = new Date();
      let endTimeDate = null;
      if (cachedSettings.endTime) {
        const parts = cachedSettings.endTime.split(':');
        if (parts.length === 2) {
          endTimeDate = new Date(now);
          endTimeDate.setHours(parseInt(parts[0]), parseInt(parts[1]), 0, 0);
        }
      }

      let remainingSecs = 0;
      if (cachedPlaylist.items && cachedPlaylist.currentIndex >= 0) {
          for (let i = cachedPlaylist.currentIndex; i < cachedPlaylist.items.length; i++) {
              remainingSecs += Number(cachedPlaylist.items[i].duration || 0);
          }
      } else {
          remainingSecs = cachedPlaylist.totalSecs || 0;
      }

      for (const it of items) {
        const el = document.createElement('div'); el.className = 'item';
        const img = document.createElement('img'); img.src = it.cover || '';
        const meta = document.createElement('div'); meta.className = 'meta';
        const t = document.createElement('div'); t.className = 'title'; t.textContent = it.title || '';
        const a = document.createElement('div'); a.className = 'artist'; a.textContent = (it.artist||'') + (it.album? ' · ' + it.album : '');
        meta.appendChild(t); meta.appendChild(a);
        el.appendChild(img); el.appendChild(meta);
        const menu = document.createElement('div'); menu.className = 'menu';
        const actions = document.createElement('div'); actions.className = 'actions';
        
        // Warning logic
        let warnEl = null;
        if (endTimeDate && now < endTimeDate) {
            const songDur = Number(it.duration || 0);
            const predictedFinish = new Date(now.getTime() + (remainingSecs + songDur) * 1000);
            if (predictedFinish > endTimeDate) {
                warnEl = document.createElement('span');
                warnEl.style.color = '#ff4d4f';
                warnEl.style.fontSize = '12px';
                warnEl.style.marginRight = '8px';
                warnEl.style.display = 'flex';
                warnEl.style.alignItems = 'center';
                const finishStr = `${String(predictedFinish.getHours()).padStart(2,'0')}:${String(predictedFinish.getMinutes()).padStart(2,'0')}`;
                warnEl.innerHTML = `<i class="ri-alarm-warning-line" style="margin-right:2px"></i> 预计 ${finishStr} 完播`;
            }
        }

        const mTail = document.createElement('button'); mTail.innerHTML = '<i class="ri-play-list-2-line"></i> 插入到队列尾部';
        const mPlay = document.createElement('button'); mPlay.innerHTML = '<i class="ri-play-fill"></i> 立即播放';
        const mNext = document.createElement('button'); mNext.innerHTML = '<i class="ri-skip-forward-fill"></i> 下一首播放';
        const mDownload = document.createElement('button'); mDownload.innerHTML = '<i class="ri-download-line"></i> 下载歌曲';
        function hideFloating(){ try { window.lowbarAPI.emitEvent('music-radio', { type:'update', target:'floatingUrl', value: null }); } catch (e) {} }
        mTail.onclick = async (e) => { e.stopPropagation(); hideFloating(); await window.lowbarAPI.pluginCall('music-radio', 'enqueueTail', [it]); };
        mPlay.onclick = async (e) => { e.stopPropagation(); hideFloating(); const r = await window.lowbarAPI.pluginCall('music-radio', 'playNow', [it]); if (!(r && (r.result ? r.result.ok : r.ok))) alert('播放失败'); };
        mNext.onclick = async (e) => { e.stopPropagation(); hideFloating(); await window.lowbarAPI.pluginCall('music-radio', 'enqueueNext', [it]); };
        mDownload.onclick = async (e) => { e.stopPropagation(); if(confirm(`确认下载 "${it.title}" 吗？`)) { await window.lowbarAPI.pluginCall('music-radio', 'downloadSong', [it]); } };
        
        if (warnEl) actions.appendChild(warnEl);
        actions.appendChild(mTail); actions.appendChild(mPlay); actions.appendChild(mNext); actions.appendChild(mDownload);
        menu.appendChild(actions);
        const ctrl = document.createElement('div'); ctrl.className = 'controls';
        const btnExpand = document.createElement('button'); btnExpand.innerHTML = '<i class="ri-arrow-down-s-line"></i> 展开';
        btnExpand.onclick = (e) => { e.stopPropagation(); if (openMenu && openMenu !== menu) openMenu.style.display = 'none'; menu.style.display = (menu.style.display === 'none' || !menu.style.display) ? 'block' : 'none'; openMenu = menu.style.display === 'block' ? menu : null; };
        ctrl.appendChild(btnExpand);
        el.appendChild(ctrl);
        el.onclick = () => {
          if (openMenu && openMenu !== menu) openMenu.style.display = 'none';
          menu.style.display = menu.style.display === 'none' || !menu.style.display ? 'block' : 'none';
          openMenu = menu.style.display === 'block' ? menu : null;
        };
        r.appendChild(el);
        r.appendChild(menu);
      }
    }
    async function loadPage(append){
      if (loading) return;
      loading = true;
      // Fetch caches before rendering
      await updateCaches(); 
      const r = document.getElementById('result');
      const btn = document.getElementById('loadmore');
      const pageInfo = document.getElementById('pageinfo');
      const dbg = document.getElementById('debugjson');
      const sbtn = document.getElementById('searchbtn');
      const lbar = document.getElementById('loadingbar');
      btn.disabled = true;
      if (sbtn) sbtn.disabled = true;
      if (lbar) { lbar.style.display = 'flex'; }
      
      const res = await window.lowbarAPI.pluginCall('music-radio', 'search', [currentQuery, currentPage, currentSource]);
      
      const data = res && res.result ? res.result : res;
      if (!data || data.ok === false) {
        if (!append) r.textContent = '搜索失败';
        const txt = (data && data.raw) ? data.raw : JSON.stringify(res || {});
        dbg.textContent = String(txt || '');
        dbg.style.display = 'block';
      loading = false;
      btn.disabled = false;
      if (sbtn) sbtn.disabled = false;
      if (lbar) { lbar.style.display = 'none'; }
      return;
    }
      const items = Array.isArray(data.items) ? data.items : [];
      hasMore = !!data.hasMore;
      if (!append) r.innerHTML = '';
      if (!items.length && !append) { r.textContent = '未找到结果'; }
      else renderItems(items);
      if (!items.length) {
        const txt = (data && data.raw) ? data.raw : JSON.stringify(data || {});
        dbg.textContent = String(txt || '');
        dbg.style.display = 'block';
      } else {
        dbg.textContent = '';
        dbg.style.display = 'none';
      }
      btn.style.display = hasMore ? 'inline-block' : 'none';
      pageInfo.textContent = `第 ${currentPage+1} 页`;
      loading = false;
      btn.disabled = false;
      if (sbtn) sbtn.disabled = false;
      if (lbar) { lbar.style.display = 'none'; }
    }
    async function doSearch(){
      const q = document.getElementById('q').value.trim();
      const r = document.getElementById('result');
      r.style.display = 'block';
      if (!q) { r.innerHTML = '请输入关键词'; return; }
      searchSeq += 1;
      const seq = searchSeq;
      r.innerHTML = '';
      const dbg = document.getElementById('debugjson');
      if (dbg) { dbg.textContent = ''; dbg.style.display = 'none'; }
      const btn = document.getElementById('loadmore');
      if (btn) { btn.style.display = 'none'; btn.disabled = true; }
      currentQuery = q;
      currentPage = 0;
      loading = false;
      await loadPage(false);
      if (seq !== searchSeq) return;
    }
    
    async function initSources(){
      const sel = document.getElementById('source');
      if (!sel) return;
      try {
          // Wait a bit for backend to register sources?
          // Retry a few times
          let sources = [];
          for (let i=0; i<3; i++) {
              const res = await window.lowbarAPI.pluginCall('music-radio', 'getAudioSources', []);
              const data = (res && res.result) ? res.result : res;
              if (data && data.ok && Array.isArray(data.sources) && data.sources.length > 0) {
                  sources = data.sources;
                  break;
              }
              await new Promise(r => setTimeout(r, 500));
          }
          
          if (sources.length > 0) {
              sel.innerHTML = '';
              sources.forEach(s => {
                  const opt = document.createElement('option');
                  opt.value = s.id;
                  opt.textContent = s.name;
                  sel.appendChild(opt);
              });
              if (sources.find(s => s.id === 'kuwo')) currentSource = 'kuwo';
              else currentSource = sources[0].id;
              sel.value = currentSource;
          }
      } catch (e) { console.error('Failed to load sources', e); }
      sel.addEventListener('change', () => { currentSource = sel.value; });
    }

    window.addEventListener('DOMContentLoaded', initSources);
    window.addEventListener('DOMContentLoaded', () => { const iq = document.getElementById('q'); if (iq) { iq.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); }); try { iq.focus(); } catch (e) {} } });
  </script>
</head>
<body>
  <div class="wrap">
    <header>搜索歌曲</header>
    <div class="content">
      <input id="q" placeholder="输入歌名/艺术家" />
      <select id="source">
        <option value="kuwo">默认源</option>
      </select>
      <button id="searchbtn" onclick="doSearch()"><i class="ri-search-line"></i> 搜索</button>
    </div>
    <div class="tip">请单击目标歌曲以调起播放菜单</div>
    <div class="scroll">
      <div id="result" class="result">输入关键词后显示结果</div>
      <div id="loadingbar" class="loadingbar"><i class="ri-loader-4-line spin"></i> 正在搜索…</div>
      <div style="padding: 8px 16px; display:flex; align-items:center; gap:12px;">
        <span id="pageinfo">第 1 页</span>
        <button id="loadmore" style="display:none;" onclick="(async()=>{ if (!hasMore) return; currentPage += 1; await loadPage(true); })()">加载更多</button>
      </div>
      <pre id="debugjson" style="display:none; padding:8px 16px; margin:0; border-top:1px solid #2a2a2a; color:#9ad; white-space:pre-wrap; word-break:break-all; max-height:200px; overflow:auto;"></pre>
    </div>
  </div>
</body>
</html>
