<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>发现</title>
  <link rel="stylesheet" href="../../../renderer/remixicon-local.css" />
  <style>
    :root {
      --bg: #181818;
      --sidebar-bg: #202020;
      --fg: #e6e6e6;
      --muted: #aaa;
      --border: #2a2a2a;
      --input-bg: #2a2a2a;
      --accent: #6ab4ff;
      --accent-rgb: 106, 180, 255;
      --hover: #333;
      --active: #383838;
      --panel: rgba(255, 255, 255, 0.04);
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font-family: system-ui, Segoe UI, PingFang SC, Microsoft YaHei, sans-serif; transition: background 0.3s, color 0.3s; overflow: hidden; }
    
    .layout {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    /* Header & Tabs */
    header {
        padding: 20px 20px 10px 20px;
    }
    h1 {
        margin: 0 0 16px 0;
        font-size: 24px;
        font-weight: 600;
        color: var(--fg);
    }

    .subnav {
      display: flex;
      gap: 8px;
      /* padding: 0 20px; */ /* Already in header/layout */
      flex-wrap: wrap;
    }

    .sub-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      color: var(--muted);
      border: 1px solid transparent;
      border-radius: 999px;
      padding: 6px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
    }

    .sub-item:hover {
      background: var(--panel);
      color: var(--fg);
    }

    .sub-item.active {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(var(--accent-rgb), 0.3);
    }
    
    .sub-item i { font-size: 16px; }

    /* Content */
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; padding: 0 20px 20px 20px; }
    .page { display: none; width: 100%; height: 100%; flex: 1; overflow: hidden; border-radius: 12px; background: var(--panel); border: 1px solid var(--border); }
    .page.active { display: block; }
    iframe { width: 100%; height: 100%; border: none; display: block; }
    
    .empty-tip {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--muted);
        font-size: 14px;
    }

    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  </style>
</head>
<body>
  <div class="layout">
    <header>
        <h1>发现</h1>
        <div class="subnav" id="subnav">
            <!-- Tabs injected here -->
        </div>
    </header>
    
    <div class="main" id="main">
      <div class="empty-tip" id="emptyTip">
          <i class="ri-compass-3-line" style="font-size: 48px; margin-bottom: 12px; opacity: 0.5;"></i>
          <div>暂无发现内容</div>
      </div>
    </div>
  </div>

  <script>
    // --- Theme Logic ---
    window.applyTheme = (mode, color) => {
      const root = document.documentElement;
      const isDark = mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
      const accent = color || '#6ab4ff';
      root.style.setProperty('--accent', accent);
      
      // Calculate RGB for accent-rgb
      // Simple hex to rgb
      let r=0, g=0, b=0;
      if (accent.length === 4) {
        r = parseInt(accent[1] + accent[1], 16);
        g = parseInt(accent[2] + accent[2], 16);
        b = parseInt(accent[3] + accent[3], 16);
      } else if (accent.length === 7) {
        r = parseInt(accent.substring(1, 3), 16);
        g = parseInt(accent.substring(3, 5), 16);
        b = parseInt(accent.substring(5, 7), 16);
      }
      root.style.setProperty('--accent-rgb', `${r}, ${g}, ${b}`);

      if (isDark) {
        root.style.setProperty('--bg', '#181818');
        root.style.setProperty('--sidebar-bg', '#202020');
        root.style.setProperty('--fg', '#e6e6e6');
        root.style.setProperty('--muted', '#aaa');
        root.style.setProperty('--border', '#2a2a2a');
        root.style.setProperty('--input-bg', '#2a2a2a');
        root.style.setProperty('--hover', '#333');
        root.style.setProperty('--active', '#383838');
        root.style.setProperty('--panel', 'rgba(255, 255, 255, 0.04)');
      } else {
        root.style.setProperty('--bg', '#ffffff');
        root.style.setProperty('--sidebar-bg', '#f7f7f7');
        root.style.setProperty('--fg', '#333333');
        root.style.setProperty('--muted', '#666666');
        root.style.setProperty('--border', '#e0e0e0');
        root.style.setProperty('--input-bg', '#fff');
        root.style.setProperty('--hover', '#eee');
        root.style.setProperty('--active', '#e6e6e6');
        root.style.setProperty('--panel', '#f5f5f5');
      }
    };

    (async () => {
      try {
        if (window.lowbarAPI?.configGet) {
          const mode = await window.lowbarAPI.configGet('system', 'themeMode') || 'system';
          const color = await window.lowbarAPI.configGet('system', 'themeColor') || '#6ab4ff';
          window.applyTheme(mode, color);
        }
        if (window.lowbarAPI?.onConfigChanged) {
          window.lowbarAPI.onConfigChanged(({ scope, key, value }) => {
            if (scope === 'system') {
               (async () => {
                 const m = await window.lowbarAPI.configGet('system', 'themeMode') || 'system';
                 const c = await window.lowbarAPI.configGet('system', 'themeColor') || '#6ab4ff';
                 window.applyTheme(m, c);
               })();
            }
          });
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', async () => {
           const m = await window.lowbarAPI.configGet('system', 'themeMode') || 'system';
           if (m === 'system') {
              const c = await window.lowbarAPI.configGet('system', 'themeColor') || '#6ab4ff';
              window.applyTheme('system', c);
           }
        });
      } catch (e) { console.error('Theme init failed', e); }
    })();

    // --- Tab Logic ---
    let currentTabId = null;

    window.switchTab = (id) => {
      if (currentTabId === id) return;
      currentTabId = id;

      document.querySelectorAll('.sub-item').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
      
      const btn = document.getElementById(`btn-${id}`);
      const page = document.getElementById(`page-${id}`);
      
      if (btn) btn.classList.add('active');
      if (page) {
          page.classList.add('active');
          // Lazy load iframe
          const iframe = page.querySelector('iframe');
          if (iframe && !iframe.src && iframe.dataset.src) {
              iframe.src = iframe.dataset.src;
          }
      }
      
      document.getElementById('emptyTip').style.display = page ? 'none' : 'flex';
    };

    // --- Main Logic ---
    (async function(){
      const subnav = document.getElementById('subnav');
      const main = document.getElementById('main');

      try {
        const r = await window.lowbarAPI.pluginCall('music-radio', 'getAudioSources', []);
        const sources = (r && r.result ? r.result.sources : (r && r.sources ? r.sources : [])) || [];
        
        const validSources = sources.filter(s => s.discoveryPage);
        
        if (validSources.length === 0) {
            return;
        }

        document.getElementById('emptyTip').style.display = 'none';

        validSources.forEach((s, index) => {
            // Create Tab Button
            const btn = document.createElement('button');
            btn.className = 'sub-item';
            btn.id = `btn-${s.id}`;
            btn.onclick = () => switchTab(s.id);
            // Default icon if not provided? Use disc-line
            btn.innerHTML = `<i class="ri-disc-line"></i> ${s.name}`;
            subnav.appendChild(btn);

            // Create Page Content
            const page = document.createElement('div');
            page.className = 'page';
            page.id = `page-${s.id}`;
            
            const iframe = document.createElement('iframe');
            iframe.dataset.src = s.discoveryPage; // Load on activate
            page.appendChild(iframe);
            
            main.appendChild(page);

            // Activate first tab
            if (index === 0) {
                switchTab(s.id);
            }
        });

      } catch (e) {
          console.error('Failed to load discovery sources', e);
      }
    })();
  </script>
</body>
</html>